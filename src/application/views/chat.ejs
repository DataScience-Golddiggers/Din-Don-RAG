<%- include('partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-5">
    <h1>Chat con l'Assistente</h1>

    <div class="card shadow chat-container d-flex flex-column mt-2 mb-5" style="height: 60vh; max-height: 60vh; overflow-y: auto;" id="chatContainer">
        <div class="message bot-message">
            Ciao! Come posso aiutarti oggi riguardo l'UnivPM? Posso anche mostrarti statistiche su voti e corsi!
        </div>
    </div>

    <div class="input-group mt-4 mb-2 shadow mx-auto" style="max-width: 70%;">
        <input type="text" id="userInput" class="form-control" placeholder="Scrivi la tua domanda..." aria-label="Domanda">
        <button class="btn btn-custom" type="button" id="sendBtn">Invia</button>
    </div>
</div>

<script>
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    function appendMessage(content, isUser, isHtml = false) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(isUser ? 'user-message' : 'bot-message');
        
        if (isHtml) {
            div.innerHTML = content;
        } else {
            div.textContent = content;
        }
        
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return div; // Return element to allow further manipulation (e.g. chart rendering)
    }

    function renderChart(canvasId, config) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, config);
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage(text, true);
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = 'Elaborazione...';

        try {
            const response = await fetch('/api/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: text })
            });

            const data = await response.json();

            if (response.ok) {
                appendMessage(data.answer, false);
                
                // Handle Dashboard / Chart
                if (data.dashboard_data) {
                    // Normalize to array if single chart (backward compatibility)
                    let charts = [];
                    if (data.dashboard_data.type === 'multi-dashboard' && data.dashboard_data.charts) {
                        charts = data.dashboard_data.charts;
                    } else if (data.dashboard_data.chart_config) {
                        charts = [data.dashboard_data];
                    }

                    charts.forEach((chartItem, index) => {
                        if (chartItem.chart_config && Object.keys(chartItem.chart_config).length > 0) {
                            const chartId = 'chart-' + Date.now() + '-' + index;
                            const titleHtml = chartItem.title ? `<strong>${chartItem.title}</strong><br>` : '';
                            const chartHtml = `
                                <div class="chart-wrapper mb-3 p-2 border rounded">
                                    ${titleHtml}
                                    <div class="chart-container" style="position: relative; height:300px; width:100%">
                                        <canvas id="${chartId}"></canvas>
                                    </div>
                                    <small class="text-muted" style="font-size:0.75rem">SQL: ${chartItem.sql}</small>
                                </div>
                            `;
                            appendMessage(chartHtml, false, true);
                            
                            // Render chart after DOM update
                            setTimeout(() => {
                                renderChart(chartId, chartItem.chart_config);
                            }, 150 * (index + 1));
                        }
                    });
                }

            } else {
                appendMessage("Errore: " + (data.error || "Impossibile contattare il server."), false);
            }
        } catch (error) {
            console.error(error);
            appendMessage("Errore di connessione.", false);
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'Invia';
            userInput.focus();
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>

<%- include('partials/footer') %>
