<%- include('partials/header') %>

<div class="container mt-5">
    <h1>Legacy Chat (Crawler + Ollama)</h1>
    <p class="text-muted">Questa chat usa il vecchio sistema di ricerca testuale sul sito UnivPM.</p>

    <div class="card shadow chat-container d-flex flex-column mt-2 mb-5" style="height: 60vh; max-height: 60vh; overflow-y: auto;" id="chatContainer">
        <div class="message bot-message">
            Ciao! Sono il vecchio sistema. Posso cercare informazioni sul sito UnivPM per te.
        </div>
    </div>

    <div class="input-group mt-4 mb-2 shadow mx-auto" style="max-width: 70%;">
        <input type="text" id="userInput" class="form-control" placeholder="Cerca nel sito (es. bandi, contatti)..." aria-label="Domanda">
        <button class="btn btn-secondary" type="button" id="sendBtn">Cerca (Legacy)</button>
    </div>
</div>

<script>
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    function appendMessage(content, isUser) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(isUser ? 'user-message' : 'bot-message');
        div.textContent = content;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage(text, true);
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = 'Elaborazione...';

        try {
            const response = await fetch('/api/ask-legacy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: text })
            });

            const data = await response.json();

            if (response.ok) {
                appendMessage(data.answer, false);
            } else {
                appendMessage("Errore: " + (data.error || "Impossibile contattare il server."), false);
            }
        } catch (error) {
            console.error(error);
            appendMessage("Errore di connessione.", false);
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'Cerca (Legacy)';
            userInput.focus();
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>

<%- include('partials/footer') %>
